<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mlx.data.Stream.dynamic_batch &mdash; MLX Data 0.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="mlx.data.Stream.partition" href="mlx.data.Stream.partition.html" />
    <link rel="prev" title="mlx.data.Stream.line_reader_from_key" href="mlx.data.Stream.line_reader_from_key.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MLX Data
          </a>
              <div class="version">
                0.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Build and Install</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../buffers_streams_samples.html">Buffers, Streams and Samples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../dataset.html">Common operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../buffer.html">Buffer</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../stream.html">Stream</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../stream.html#factory-methods">Factory methods</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../stream.html#stream-specific-api">Stream specific API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="mlx.data.Stream.csv_reader_from_key.html">mlx.data.Stream.csv_reader_from_key</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlx.data.Stream.line_reader_from_key.html">mlx.data.Stream.line_reader_from_key</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">mlx.data.Stream.dynamic_batch</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlx.data.Stream.partition.html">mlx.data.Stream.partition</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlx.data.Stream.buffered.html">mlx.data.Stream.buffered</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlx.data.Stream.repeat.html">mlx.data.Stream.repeat</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlx.data.Stream.shuffle.html">mlx.data.Stream.shuffle</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlx.data.Stream.sliding_window.html">mlx.data.Stream.sliding_window</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlx.data.Stream.prefetch.html">mlx.data.Stream.prefetch</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../common_datasets.html">Common Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tokenizing.html">Tokenizing with MLX data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features.html">Feature extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous.html">Miscellaneous</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MLX Data</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../stream.html">Stream</a></li>
      <li class="breadcrumb-item active">mlx.data.Stream.dynamic_batch</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/python/_autosummary/mlx.data.Stream.dynamic_batch.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="mlx-data-stream-dynamic-batch">
<h1>mlx.data.Stream.dynamic_batch<a class="headerlink" href="#mlx-data-stream-dynamic-batch" title="Permalink to this headline"></a></h1>
<dl class="py method">
<dt class="sig sig-object py" id="mlx.data.Stream.dynamic_batch">
<span class="sig-prename descclassname"><span class="pre">Stream.</span></span><span class="sig-name descname"><span class="pre">dynamic_batch</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">mlx.data._c.Stream</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">buffer_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_data_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">-</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pad</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dict</span><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.12)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">{}</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dim</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dict</span><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><span class="pre">int</span></a><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">{}</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shuffle</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.12)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_threads</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">mlx.data._c.Stream</span></span></span><a class="headerlink" href="#mlx.data.Stream.dynamic_batch" title="Permalink to this definition"></a></dt>
<dd><p>Dynamic batching returns batches with approximately the same
number of total elements.</p>
<p>This is used to minimize padding and waste of computation when
dealing with samples that can have large variance in sizes.</p>
<p>For instance if we have a stream with a key ‘tokens’ and we
want batches that contain approximately 16k tokens but the
sample sizes vary from 64 to 1024 we can use dynamic batching
to group together smaller samples to reduce padding but keep
the total amount of work approximately constant.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlx.data</span> <span class="k">as</span> <span class="nn">dx</span>

<span class="k">def</span> <span class="nf">random_sample</span><span class="p">():</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">count_padding</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">dset</span> <span class="o">=</span> <span class="n">dx</span><span class="o">.</span><span class="n">buffer_from_vector</span><span class="p">([</span><span class="n">random_sample</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10_000</span><span class="p">)])</span>

<span class="c1"># Compute the average padding size with naive batching</span>
<span class="n">naive_padding</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">count_padding</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">to_stream</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>

<span class="c1"># And with dynamic padding. Keep in mind that this also</span>
<span class="c1"># ensures that the number of tokens in a batch are</span>
<span class="c1"># approximately constant.</span>
<span class="n">dynbatch_padding</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">count_padding</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">to_stream</span><span class="p">()</span><span class="o">.</span><span class="n">dynamic_batch</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;tokens&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span>

<span class="c1"># Count the total valid tokens</span>
<span class="n">valid_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simple batching: &quot;</span><span class="p">,</span> <span class="n">naive_padding</span> <span class="o">/</span> <span class="p">(</span><span class="n">valid_tokens</span> <span class="o">+</span> <span class="n">naive_padding</span><span class="p">),</span> <span class="s2">&quot; of tokens were padding&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dynamic batching: &quot;</span><span class="p">,</span> <span class="n">dynbatch_padding</span> <span class="o">/</span> <span class="p">(</span><span class="n">valid_tokens</span> <span class="o">+</span> <span class="n">dynbatch_padding</span><span class="p">),</span> <span class="s2">&quot; of tokens were padding&quot;</span><span class="p">)</span>

<span class="c1"># prints approximately 40% of tokens were padding in the first case</span>
<span class="c1"># and 5% of tokens in the second case</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>buffer_size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a>) – How many buffers to consider when computing the dynamic batching</p></li>
<li><p><strong>key</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><em>str</em></a>) – Which array’s size to use for the dynamic batching</p></li>
<li><p><strong>max_data_size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a>) – How many elements of the array at
<code class="docutils literal notranslate"><span class="pre">key</span></code> should each batch have. If less or equal to 0 then
batch the whole buffer in which case dynamic batching behaves
similar to <code class="docutils literal notranslate"><span class="pre">batch</span></code>. (default: -1)</p></li>
<li><p><strong>pad</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.12)"><em>dict</em></a>) – The values to use for padding for each key in the samples.</p></li>
<li><p><strong>dim</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.12)"><em>dict</em></a>) – The dimension to concatenate over.</p></li>
<li><p><strong>shuffle</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.12)"><em>bool</em></a>) – If true shuffle the batches before returning
them. Otherwise the larger batch sizes with smaller samples
will be first and so on. (default: False)</p></li>
<li><p><strong>num_threads</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a>) – How many parallel threads to use to fill the buffer. (default: 1)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mlx.data.Stream.line_reader_from_key.html" class="btn btn-neutral float-left" title="mlx.data.Stream.line_reader_from_key" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mlx.data.Stream.partition.html" class="btn btn-neutral float-right" title="mlx.data.Stream.partition" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, MLX Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>